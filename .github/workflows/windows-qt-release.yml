name: Windows Qt Release (MSVC 2019 x64)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-2019

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 6.7.3
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          modules: qt5compat qtmultimedia
          cache: true

      - name: Configure CMake
        run: |
          cmake -S . -B build `
            -G "Visual Studio 16 2019" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}"

      - name: Build
        run: |
          cmake --build build --config Release

      # ---------------------------------------------------------
      # Detect App Name & Deploy Qt DLLs
      # ---------------------------------------------------------
      - name: Deploy Qt artifacts & Detect Name
        shell: powershell
        run: |
          # 1. Find the built executable
          $exePath = Get-ChildItem -Path build\Release\*.exe | Select-Object -First 1
          
          if (-not $exePath) {
            Write-Error "Executable not found! Build might have failed."
            exit 1
          }

          # 2. Extract the name (e.g., "MyAutoName.exe" -> "MyAutoName")
          $appName = $exePath.BaseName
          Write-Host "Detected App Name from CMake build: $appName"

          # 3. Save to GitHub Environment so subsequent steps can see ${{ env.APP_NAME }}
          "APP_NAME=$appName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

          # 4. Run windeployqt
          windeployqt --release --compiler-runtime --no-translations $exePath.FullName

      # ---------------------------------------------------------
      # Package using the detected name
      # ---------------------------------------------------------
      - name: Package Release folder
        shell: powershell
        run: |
          # Use the detected name to build the zip filename
          $filename = "${{ env.APP_NAME }}-${{ github.ref_name }}-windows-msvc2019-x64.tar.gz"
          
          Write-Host "Packaging $filename..."
          
          # Rename 'Release' folder to the App Name so the user sees a nice folder when unzipping
          Rename-Item -Path "build\Release" -NewName "${{ env.APP_NAME }}"
          
          # Create the tarball
          tar -C build -czf $filename "${{ env.APP_NAME }}"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          # This reads the specific file we created above
          files: ${{ env.APP_NAME }}-${{ github.ref_name }}-windows-msvc2019-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}