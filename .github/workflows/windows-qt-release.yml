name: Windows Qt Release (MSVC 2019 x64)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-2019

    steps:
      # -----------------------------
      # Checkout source
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Install Qt 6.7.3 (MSVC 2019 x64)
      # -----------------------------
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 6.7.3
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          modules: qt5compat qtmultimedia
          cache: true

      # -----------------------------
      # Configure CMake
      # -----------------------------
      - name: Configure CMake
        run: |
          cmake -S . -B build `
            -G "Visual Studio 16 2019" `
            -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}"

      # -----------------------------
      # Build
      # -----------------------------
      - name: Build
        run: |
          cmake --build build --config Release

      # -----------------------------
      # Deploy Qt artifacts (The Fix)
      # -----------------------------
      - name: Deploy Qt artifacts
        shell: powershell
        run: |
          # Find the executable automatically
          $exePath = Get-ChildItem -Path build\Release\*.exe | Select-Object -First 1
          
          if (-not $exePath) {
            Write-Error "Executable not found in build/Release!"
            exit 1
          }

          Write-Host "Running windeployqt on: $($exePath.FullName)"
          
          # Run windeployqt to copy DLLs and plugins to the folder
          # --compiler-runtime copies MSVC runtimes (vcruntime140.dll etc) so users don't need to install them manually
          windeployqt --release --compiler-runtime --no-translations $exePath.FullName

      # -----------------------------
      # Tar the entire Release folder
      # -----------------------------
      - name: Package Release folder
        run: |
          # The DLLs are now inside build/Release, so this will package them
          tar -C build -czf Release-windows-msvc2019-x64.tar.gz Release

      # -----------------------------
      # Create GitHub Release
      # -----------------------------
      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: Release-windows-msvc2019-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}